# 网络协议
***
## TCP包头

* 源端口 ： 16个位=4个十六进制
* 目标端口：16个位=4个十六进制
* seq序号： 32个位=8个十六进制
* ack确认号：32个位=8个十六进制
* 数据偏移：4个位=1个十六进制 #告诉报文段的长度，单位是32位即4个位，最大是15也就是60个位。
* 保留位：  6个位
* URG：紧急标志，是紧急数据=1
* ACK：确认标志，确认=1
* PSH：应用程序是否立即从TCP接收缓冲区读走数据，立即=1
* RST：复位标志，重新建立=1
* SYN：同步标志，发起建立的时候=1
* FIN：结束标志，通知对方本端关闭或者数据发送完毕=1

## 有限状态机FSM:Finite State Machine 

* CLOSED 没有任何连接状态 
* LISTEN 侦听状态，等待来自远方TCP端口的连接请求 
* SYN-SENT 在发送连接请求后，等待对方确认 
* SYN-RECEIVED 在收到和发送一个连接请求后，等待对方确认 
* ESTABLISHED 代表传输连接建立，双方进入数据传送状态 
* FIN-WAIT-1 主动关闭,主机已发送关闭连接请求，等待对方确认 
* FIN-WAIT-2 主动关闭,主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求 
* TIME-WAIT 完成双向传输连接关闭，等待所有分组消失 
* CLOSE-WAIT 被动关闭,收到对方发来的关闭连接请求，并已确认 
* LAST-ACK      被动关闭,等待最后一个关闭传输连接确认，并等待所有分组消失 
* CLOSING 双方同时尝试关闭传输连接，等待对方确认 

## IP PDU报头 
* 版本:  占4位,指 IP 协议的版本目前的IP协议版本号为4
* 首部长度:  占4位,可表示的最大数值是15个单位，一个单位为4字节，因此IP 的首部长度的最大值是60字节
* 区分服务:  占8位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一直未被使用过.后改名为区分服务.只有在使用区分服务(DiffServ)时,这个字段才起作用.一般的情况下不使用
* 总长度:  占16位,指首部和数据之和的长度,单位为字节,因此数据报的最大长度为65535 字节.总长度必须不超过最大传送单元 MTU
* 标识:  占16位,它是一个计数器,通常，每发送一个报文，该值会加1， 也用于数据包分片，在同一个包的若干分片中，该值是相同的	
* 标志(flag):占3位,目前只有后两位有意义 
* DF：  Don't Fragment中间的一位，只有当 DF=0 时才允许分片
* MF：  More Fragment最后一位，MF=1表示后面还有分片,MF=0表示最后一个分片
* 片偏移:占12位,指较长的分组在分片后，该分片在原分组中的相对位置.片偏移以8个字节为偏移单位 
* 生存时间:占8位,记为TTL (Time To Live) 数据报在网络中可通过的路由器数的最大值,TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字RFC 指定,当前值为 64.发送 ICMP 回显应答时经常把 TTL 设为最大值 255 
* 协议:占8位,指出此数据报携带的数据使用何种协议以便目的主机的IP层将数据部分上交给哪个处理过程, 1表示为 ICMP 协议, 2表示为 IGMP 协议, 6表示为TCP 协议, 17表示为 UDP 协议 
* 首部检验和:占16位,只检验数据报的首部不检验数据部分.这里不采用 CRC 检验码而采用简单的计算方法 
* 源地址和目的地址:都各占4字节,分别记录源地址和目的地址

## 计算公式
1.  网络数：2^可变网络ID数
2. 最大主机数：2^主机ID数-2
3. CIDR表示法：IP/网络ID位数
4. 网络ID值=IP与掩码二进制做 与 运算 ，和子网掩码里面1做 与 运算，不变，和0 与 取0
5. 划分子网：一个大网划分成多个小网，网络ID位变多，主机ID位才变少，网络ID向主机借N位，分成2^N个小网
6. 合并网络：优化网络ID值和掩码，将小网合并成大网，优化路由

## 路由三大要素
* 目标网络ID：目标ip所在的网络ID   # [-host|-net|default]
* 网关：到达目标网络需要将数据报文交给 （下一个路由器）的哪个接口的对应IP # gw
* 接口：本设备要发送数据报文从（本设备）哪个接口发出  # dev




